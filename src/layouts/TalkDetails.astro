---
import { render, type CollectionEntry } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Tag from "@/components/Tag.astro";
import BackButton from "@/components/BackButton.astro";
import { SITE } from "@/config";
import { slugifyStr } from "@/utils/slugify";

export interface Props {
  talk: CollectionEntry<"talks">;
}

const { talk } = Astro.props;

const {
  title,
  event,
  date,
  venue,
  slideUrl,
  videoUrl,
  eventUrl,
  ogpImage,
  tags,
} = talk.data;

const { Content } = await render(talk);

// フォーマット済みの日付
const formatDate = (date: Date) => {
  return date.toLocaleDateString("ja-JP", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

const layoutProps = {
  title: `${title} | ${SITE.title}`,
  description: `${event}での登壇: ${title}`,
  ogImage: ogpImage,
  scrollSmooth: true,
};
---

<Layout {...layoutProps}>
  <Header />
  <BackButton />
  <main
    id="main-content"
    class:list={[
      "mx-auto w-full max-w-app px-4 pb-12",
      { "mt-8": !SITE.showBackButton },
    ]}
  >
    <article class="mx-auto prose prose-lg">
      <!-- OGP画像 -->
      {
        ogpImage && (
          <div class="mb-8 overflow-hidden rounded-lg">
            <img
              src={ogpImage}
              alt={title}
              class="h-auto w-full object-cover"
              loading="eager"
            />
          </div>
        )
      }

      <!-- タイトル -->
      <h1 class="mb-4 text-2xl font-bold text-accent sm:text-3xl">
        {title}
      </h1>

      <!-- イベント情報 -->
      <div class="mb-6 text-foreground">
        <p class="text-lg font-medium">{event}</p>
        {venue && <p class="text-muted">@ {venue}</p>}
        <p class="text-sm text-muted">{formatDate(date)}</p>
      </div>

      <!-- リンクボタン -->
      <div class="not-prose mb-8 flex flex-wrap gap-3">
        {
          slideUrl && (
            <a
              href={slideUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 rounded-lg bg-accent px-5 py-2.5 text-sm font-medium text-background shadow-sm transition-all hover:opacity-90"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                <line x1="8" y1="21" x2="16" y2="21" />
                <line x1="12" y1="17" x2="12" y2="21" />
              </svg>
              <span>Slides</span>
            </a>
          )
        }
        {
          videoUrl && (
            <a
              href={videoUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 rounded-lg border-2 border-border bg-background px-5 py-2.5 text-sm font-medium text-foreground shadow-sm transition-all hover:border-accent hover:bg-muted"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polygon points="5 3 19 12 5 21 5 3" />
              </svg>
              <span>Video</span>
            </a>
          )
        }
        {
          eventUrl && (
            <a
              href={eventUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 rounded-lg border-2 border-border bg-background px-5 py-2.5 text-sm font-medium text-foreground shadow-sm transition-all hover:border-accent hover:bg-muted"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
              </svg>
              <span>Event Page</span>
            </a>
          )
        }
      </div>

      <!-- タグ -->
      {
        tags && tags.length > 0 && (
          <ul class="not-prose mb-8 flex flex-wrap gap-x-2 gap-y-1">
            {tags.map(tag => (
              <Tag tag={slugifyStr(tag)} tagName={tag} />
            ))}
          </ul>
        )
      }

      <!-- Markdownコンテンツ -->
      <div
        class="prose-headings:text-foreground prose-p:text-foreground prose-a:text-accent prose-blockquote:text-foreground prose-strong:text-foreground prose-code:text-foreground prose-pre:bg-muted prose-ol:text-foreground prose-ul:text-foreground"
      >
        <Content />
      </div>
    </article>
  </main>
  <Footer />
</Layout>
